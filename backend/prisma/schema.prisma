generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id             String          @id @default(uuid())
  name           String
  address        String
  city           String
  state          String
  country        String
  postalCode     String
  phone          String
  email          String          @unique
  website        String?
  logo           String?
  gradingScale   Json?           // School-specific grading configuration
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  auditLogs      AuditLog[]
  classes        Class[]
  dashboardPosts DashboardPost[]
  notifications  Notification[]
  quizzes        Quiz[]
  students       Student[]
  subjects       Subject[]
  textbooks      Textbook[]
  users          User[]

  @@index([email])
  @@index([isActive])
}

model User {
  id                    String             @id @default(uuid())
  schoolId              String
  email                 String             @unique
  phone                 String?
  password              String
  firstName             String
  lastName              String
  role                  UserRole
  profileImage          String?
  isActive              Boolean            @default(true)
  lastLogin             DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  attendanceRecords     Attendance[]
  auditLogs             AuditLog[]
  chatMessages          ChatMessage[]
  dashboardPosts        DashboardPost[]
  marksRecords          Marks[]
  notificationsSent     Notification[]     @relation("SentNotifications")
  quizzesCreated        Quiz[]
  refreshTokens         RefreshToken[]
  remarks               Remark[]
  teacherClasses        TeacherClass[]
  teacherSubjects       TeacherSubject[]
  classSubjects         ClassSubject[]     // Per-class subject assignments
  school                School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  notificationsReceived UserNotification[]

  @@index([schoolId])
  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model StudentRefreshToken {
  id        String   @id @default(uuid())
  studentId String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([token])
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model Class {
  id             String         @id @default(uuid())
  schoolId       String
  name           String
  section        String?
  grade          String
  academicYear   String
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  attendances    Attendance[]
  school         School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subjects       ClassSubject[]
  notifications  Notification[]
  quizzes        Quiz[]
  students       Student[]
  teacherClasses TeacherClass[]

  @@unique([schoolId, name, section, academicYear])
  @@index([schoolId])
  @@index([grade])
}

model Subject {
  id              String           @id @default(uuid())
  schoolId        String
  name            String
  code            String
  description     String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  classSubjects   ClassSubject[]
  marks           Marks[]
  notifications   Notification[]
  quizzes         Quiz[]
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacherSubjects TeacherSubject[]
  textbooks       Textbook[]

  @@unique([schoolId, code])
  @@index([schoolId])
}

model ClassSubject {
  id        String   @id @default(uuid())
  classId   String
  subjectId String
  teacherId String?  // Teacher assigned to this subject for this specific class
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   User?    @relation(fields: [teacherId], references: [id], onDelete: SetNull)

  @@unique([classId, subjectId])
  @@index([classId])
  @@index([subjectId])
  @@index([teacherId])
}

model TeacherClass {
  id        String   @id @default(uuid())
  userId    String
  classId   String
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
}

model TeacherSubject {
  id        String   @id @default(uuid())
  userId    String
  subjectId String
  createdAt DateTime @default(now())
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId])
  @@index([userId])
  @@index([subjectId])
}

model Student {
  id                    String                @id @default(uuid())
  schoolId              String
  classId               String
  rollNumber            String
  firstName             String
  lastName              String
  email                 String?
  phone                 String?
  parentName            String
  parentPhone           String
  parentEmail           String?
  address               String?
  dateOfBirth           DateTime?
  gender                Gender?
  bloodGroup            String?
  profileImage          String?
  faceEncoding          String?
  password              String
  isActive              Boolean               @default(true)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  attendances           Attendance[]
  marks                 Marks[]
  quizAttempts          QuizAttempt[]
  refreshTokens         StudentRefreshToken[]
  remarks               Remark[]
  class                 Class                 @relation(fields: [classId], references: [id], onDelete: Cascade)
  school                School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  chatMessages          StudentChatMessage[]
  notificationsReceived StudentNotification[]

  @@unique([schoolId, classId, rollNumber])
  @@index([schoolId])
  @@index([classId])
  @@index([rollNumber])
}

model Attendance {
  id         String           @id @default(uuid())
  schoolId   String
  classId    String
  studentId  String
  teacherId  String
  date       DateTime
  status     AttendanceStatus
  method     AttendanceMethod @default(MANUAL)
  confidence Float?
  remarks    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  class      Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher    User             @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([schoolId])
  @@index([classId])
  @@index([studentId])
  @@index([date])
}

model Marks {
  id            String   @id @default(uuid())
  schoolId      String
  studentId     String
  subjectId     String
  teacherId     String
  examType      ExamType
  examName      String
  maxMarks      Float
  obtainedMarks Float
  percentage    Float
  grade         String?
  remarks       String?
  examDate      DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher       User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([studentId])
  @@index([subjectId])
}

model Remark {
  id          String     @id @default(uuid())
  schoolId    String
  studentId   String
  teacherId   String
  type        RemarkType
  title       String
  description String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  student     Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher     User       @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([studentId])
}

model Textbook {
  id          String   @id @default(uuid())
  schoolId    String
  subjectId   String
  title       String
  description String?
  author      String?
  filePath    String
  fileSize    Int
  fileType    String
  grade       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([subjectId])
}

model Quiz {
  id                 String         @id @default(uuid())
  schoolId           String
  classId            String
  subjectId          String
  teacherId          String
  title              String
  description        String?
  timeLimit          Int?
  maxAttempts        Int            @default(1)
  randomizeQuestions Boolean        @default(false)
  randomizeOptions   Boolean        @default(false)
  showResults        Boolean        @default(true)
  passingScore       Float?
  startTime          DateTime?
  endTime            DateTime?
  isAIGenerated      Boolean        @default(false)
  isActive           Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  class              Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  school             School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject            Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher            User           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  attempts           QuizAttempt[]
  questions          QuizQuestion[]

  @@index([schoolId])
  @@index([classId])
  @@index([subjectId])
}

model QuizQuestion {
  id            String              @id @default(uuid())
  quizId        String
  questionText  String
  questionType  QuestionType
  options       Json?
  correctAnswer String
  explanation   String?
  points        Float               @default(1)
  orderIndex    Int
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  answers       QuizAttemptAnswer[]
  quiz          Quiz                @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model QuizAttempt {
  id          String              @id @default(uuid())
  quizId      String
  studentId   String
  startedAt   DateTime            @default(now())
  submittedAt DateTime?
  score       Float?
  percentage  Float?
  isPassed    Boolean?
  createdAt   DateTime            @default(now())
  quiz        Quiz                @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student     Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  answers     QuizAttemptAnswer[]

  @@index([quizId])
  @@index([studentId])
}

model QuizAttemptAnswer {
  id         String       @id @default(uuid())
  attemptId  String
  questionId String
  answer     String
  isCorrect  Boolean
  points     Float        @default(0)
  createdAt  DateTime     @default(now())
  attempt    QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  schoolId  String
  role      ChatRole
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([schoolId])
  @@index([createdAt])
}

model StudentChatMessage {
  id        String   @id @default(uuid())
  studentId String
  schoolId  String
  role      ChatRole
  content   String
  createdAt DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([schoolId])
  @@index([createdAt])
}

model Notification {
  id                String                @id @default(uuid())
  schoolId          String
  senderId          String
  title             String
  message           String
  type              NotificationType
  targetType        NotificationTarget
  classId           String?
  subjectId         String?
  priority          NotificationPriority  @default(NORMAL)
  channels          Json
  scheduledAt       DateTime?
  sentAt            DateTime?
  status            NotificationStatus    @default(PENDING)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  class             Class?                @relation(fields: [classId], references: [id])
  school            School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sender            User                  @relation("SentNotifications", fields: [senderId], references: [id], onDelete: Cascade)
  subject           Subject?              @relation(fields: [subjectId], references: [id])
  deliveryLogs      NotificationLog[]
  studentRecipients StudentNotification[]
  userRecipients    UserNotification[]

  @@index([schoolId])
  @@index([senderId])
  @@index([status])
}

model UserNotification {
  id             String       @id @default(uuid())
  notificationId String
  userId         String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId])
  @@index([isRead])
}

model StudentNotification {
  id             String       @id @default(uuid())
  notificationId String
  studentId      String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([notificationId, studentId])
  @@index([studentId])
  @@index([isRead])
}

model NotificationLog {
  id             String       @id @default(uuid())
  notificationId String
  channel        String
  recipientType  String
  recipientId    String
  status         String
  errorMessage   String?
  sentAt         DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([recipientId])
}

model DashboardPost {
  id          String    @id @default(uuid())
  schoolId    String
  authorId    String
  title       String
  content     String
  type        PostType
  mediaUrls   Json?
  eventDate   DateTime? // For EVENT type posts - when the event occurs
  isPinned    Boolean   @default(false)
  isPublished Boolean   @default(true)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([authorId])
  @@index([type])
  @@index([createdAt])
  @@index([eventDate])
}

model AuditLog {
  id         String   @id @default(uuid())
  schoolId   String
  userId     String
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  school     School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

enum UserRole {
  PRINCIPAL
  TEACHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AttendanceMethod {
  MANUAL
  FACE_RECOGNITION
}

enum ExamType {
  UNIT_TEST
  MIDTERM
  FINAL
  ASSIGNMENT
  PROJECT
  QUIZ
  OTHER
}

enum RemarkType {
  POSITIVE
  NEGATIVE
  NEUTRAL
  IMPROVEMENT
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
  FILL_BLANK
}

enum ChatRole {
  USER
  ASSISTANT
}

enum NotificationType {
  ANNOUNCEMENT
  NOTICE
  ALERT
  REMINDER
  EVENT
  ATTENDANCE
  MARKS
  QUIZ
}

enum NotificationTarget {
  ALL
  TEACHERS
  STUDENTS
  CLASS
  SUBJECT
  INDIVIDUAL
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum PostType {
  UPDATE
  EVENT
  PROGRAM
  ANNOUNCEMENT
  ACHIEVEMENT
}
